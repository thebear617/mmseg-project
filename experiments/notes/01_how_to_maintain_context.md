# Agent上下文维护指南

> 本文档为AI提供维护 `AGENT_CONTEXT.md` 的标准流程和规范，确保Agent间的无痛接力。

---

## 📋 目录

- [1. 为什么需要上下文维护](#1-为什么需要上下文维护)
- [2. 新Agent启动时的操作](#2-新agent启动时的操作)
- [3. Agent完成修改后的操作](#3-agent完成修改后的操作)
- [4. 更新模式选择：追加 vs 生成](#4-更新模式选择追加-vs-生成)
- [5. 标准提示词模板](#5-标准提示词模板)
- [6. 更新检查清单](#6-更新检查清单)

---

## 1. 为什么需要上下文维护

### 问题背景

当新建一个Agent时，新Agent需要：
- 快速了解项目的整体状态
- 理解项目的组织方式和风格
- 继承之前Agent的记忆和决策
- 保持工作的一致性和连续性

### 解决方案

通过 `AGENT_CONTEXT.md` 文件实现：
- **集中存储**: 所有重要信息集中在一个文件
- **快速上手**: 新Agent只需读取一个文件即可了解项目
- **记忆传承**: 保留重要决策和变更历史
- **风格一致**: 保持代码和文档风格的一致性

---

## 2. 新Agent启动时的操作

### 标准启动流程

**提示词模板**:
```
请先读取 AGENT_CONTEXT.md，了解项目的整体情况、组织方式、风格规范和重要决策。
然后根据用户的需求进行操作。
```

**操作步骤**:
1. **读取上下文文档**: `read_file('AGENT_CONTEXT.md')`
2. **理解项目结构**: 重点关注"目录组织规范"和"重要决策记录"
3. **了解风格规范**: 查看"风格指南"和"用户偏好"
4. **查看变更历史**: 了解项目的最新状态
5. **开始工作**: 根据用户需求，参考上下文中的规范进行操作

### 快速检查清单

新Agent启动后，确认理解：
- [ ] 项目的主要工作区域是 `experiments/` 目录
- [ ] 版本控制主要管理 `experiments/`，忽略 `work_dirs/`、`data/`、`checkpoints/`
- [ ] 笔记文件按主题分类（01-05），不超过500行
- [ ] 用户偏好使用中文，需要详细解释
- [ ] 提交信息使用规范格式

---

## 3. Agent完成修改后的操作

### 何时需要更新 AGENT_CONTEXT.md

**必须更新**:
- ✅ 项目结构发生重大变化（新增/删除重要目录）
- ✅ 重要决策或约定改变
- ✅ 用户偏好发生变化
- ✅ 建立了新的工作流程或规范

**建议更新**:
- ⚠️ 添加了重要的新功能或模块
- ⚠️ 修改了关键配置文件或脚本
- ⚠️ 更新了重要的文档

**不需要更新**:
- ❌ 日常的代码修改（不影响结构）
- ❌ 实验配置的添加（已有规范）
- ❌ 小的bug修复

### 更新操作流程

**步骤1: 判断是否需要更新**
- 检查本次修改是否涉及"必须更新"的情况
- 如果不确定，倾向于更新（追加模式很安全）

**步骤2: 确定更新内容**
- 如果是新决策：添加到"重要决策记录"
- 如果是结构变化：更新"目录组织规范"
- 如果是风格变化：更新"风格指南"
- 如果是用户偏好：更新"用户偏好"

**步骤3: 追加变更记录**
- 在"变更历史"部分追加新的记录
- 格式：`YYYY-MM-DD: 变更描述`

**步骤4: 更新相关章节**
- 直接修改对应的章节内容
- 保持格式一致

---

## 4. 更新模式选择：追加 vs 生成

### 方案对比

| 特性 | 追加模式 | 生成模式 |
|------|---------|---------|
| **历史保留** | ✅ 保留完整历史 | ❌ 丢失历史信息 |
| **安全性** | ✅ 不会丢失信息 | ⚠️ 可能遗漏内容 |
| **文件大小** | ⚠️ 会逐渐增大 | ✅ 保持固定大小 |
| **可读性** | ⚠️ 需要滚动查看 | ✅ 内容精简 |
| **Git追踪** | ✅ 可通过Git查看历史 | ❌ 需要Git查看差异 |

### 推荐方案：追加模式

**选择原因**:

1. **保留历史有价值**
   - 可以看到项目的演进过程
   - 了解为什么做出某些决策
   - 便于追溯问题

2. **安全性更高**
   - 不会意外丢失重要信息
   - 追加操作更安全
   - 即使出错也容易恢复

3. **Git可以追踪**
   - 通过Git可以查看完整历史
   - 可以对比不同版本
   - 可以回退到任意版本

4. **可以定期整理**
   - 当文件过大时（>1000行）可以整理
   - 删除过时内容，保留精华
   - 保持文件的可读性

### 追加模式的具体实现

**追加位置**: "变更历史"章节

**格式**:
```markdown
### YYYY-MM-DD: 变更描述

**主要变更**:
- 变更点1
- 变更点2

**重要文件**:
- 新增/修改的文件列表

**影响**: 说明本次变更的影响
```

**示例**:
```markdown
### 2024-12-02: Agent上下文机制建立

**主要变更**:
- 创建 `AGENT_CONTEXT.md`（本文件）
- 建立Agent上下文传递机制
- 制定上下文维护规范

**重要文件**:
- 创建: `AGENT_CONTEXT.md`
- 创建: `experiments/notes/01_how_to_maintain_context.md`

**影响**: 实现Agent间的无痛接力，保持项目记忆连续性
```

---

## 5. 标准提示词模板

### 模板1: 新Agent启动（推荐）

```
请先读取 AGENT_CONTEXT.md，了解项目的整体情况、组织方式、风格规范和重要决策。
然后根据用户的需求进行操作。
```

### 模板2: Agent完成修改后更新上下文

```
请根据本次修改，更新 AGENT_CONTEXT.md：

1. 如果涉及重要决策或结构变化，在"重要决策记录"部分添加新记录
2. 如果涉及目录或文件组织变化，更新"目录组织规范"部分
3. 如果涉及风格或规范变化，更新"风格指南"部分
4. 在"变更历史"部分追加本次变更记录（使用追加模式）

参考 experiments/notes/01_how_to_maintain_context.md 中的更新规范。
```

### 模板3: 简化版（日常使用）

```
更新 AGENT_CONTEXT.md：
- 本次修改：[简要描述]
- 影响范围：[涉及的部分]
- 参考：experiments/notes/01_how_to_maintain_context.md
```

---

## 6. 更新检查清单

更新 `AGENT_CONTEXT.md` 时，确认：

- [ ] **读取了维护指南**: 已读取 `experiments/notes/01_how_to_maintain_context.md`
- [ ] **判断了更新必要性**: 确认是否需要更新
- [ ] **选择了更新位置**: 确定应该更新哪个章节
- [ ] **追加了变更记录**: 在"变更历史"部分追加了新记录
- [ ] **更新了相关章节**: 修改了对应的章节内容（如需要）
- [ ] **保持了格式一致**: 格式与现有内容保持一致
- [ ] **检查了文件大小**: 如果超过1000行，考虑整理

---

## 📝 更新示例

### 示例1: 添加新的目录结构

**场景**: 用户要求添加 `experiments/visualizations/` 目录用于存放可视化结果

**更新操作**:
1. 在"目录组织规范"部分添加新目录说明
2. 在"变更历史"部分追加记录：
   ```markdown
   ### 2024-12-03: 添加可视化结果目录
   
   **主要变更**:
   - 创建 `experiments/visualizations/` 目录
   - 用于存放实验可视化结果
   
   **重要文件**:
   - 创建: `experiments/visualizations/`
   
   **影响**: 统一管理可视化结果，便于查看和分享
   ```

### 示例2: 修改用户偏好

**场景**: 用户表示希望使用英文提交信息而非中文

**更新操作**:
1. 在"用户偏好"部分更新"沟通偏好"
2. 在"风格指南"部分更新"提交信息规范"
3. 在"变更历史"部分追加记录：
   ```markdown
   ### 2024-12-03: 更新提交信息规范
   
   **主要变更**:
   - 提交信息改为英文格式
   - 更新提交信息规范示例
   
   **影响**: 提高提交信息的国际化程度
   ```

---

## 🔄 定期整理建议

### 何时整理

- 文件超过1000行时
- 变更历史超过20条时
- 用户明确要求时

### 整理方法

1. **合并相似变更**: 将同一时期的相似变更合并
2. **删除过时内容**: 删除不再适用的内容
3. **精简描述**: 保留关键信息，删除冗余描述
4. **更新目录**: 如果章节结构变化，更新目录

### 整理示例

**整理前**:
```markdown
### 2024-12-02: 项目初始化
### 2024-12-02: 笔记系统优化
### 2024-12-02: Agent上下文机制建立
```

**整理后**:
```markdown
### 2024-12-02: 项目初始化和系统建立

**主要变更**:
- 创建项目结构和实验目录
- 建立笔记系统（主题分类）
- 建立Agent上下文传递机制
```

---

## 🔗 相关文档

- [Agent上下文文档](../../AGENT_CONTEXT.md) - 主上下文文件
- [笔记添加指南](./00_how_to_add_notes.md) - 笔记添加规则
- [环境设置指南](./02_environment_setup.md) - 环境设置相关
- [实验目录说明](../README.md) - 实验目录组织说明

---

**最后更新**: 2024-12-02  
**用途**: AI参考文档，帮助AI正确维护Agent上下文

